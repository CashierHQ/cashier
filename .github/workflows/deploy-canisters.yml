name: Deploy all canisters
on:
    # For main and staging branches, only trigger on closed PRs
    pull_request:
        paths:
            - "src/cashier_frontend/**"
        branches:
            - main
            - staging
            - dev
        types:
            - closed
    push:
        branches:
            - feature/deployment

# Permissions needed for the GITHUB_TOKEN
permissions:
    actions: write # This allows the workflow to delete workflow runs
    contents: read # Default permission to read the repository contents

jobs:
    setup_environment:
        runs-on: ubuntu-latest
        outputs:
            network: ${{ steps.set-env.outputs.network }}
        steps:
            - name: Set deployment network
              id: set-env
              run: |
                  # For pull requests, use base_ref, for pushes use ref_name
                  if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                    TARGET_BRANCH="${{ github.base_ref }}"
                  else
                    TARGET_BRANCH="${{ github.ref_name }}"
                  fi
                  echo "Detected branch: $TARGET_BRANCH"

                  if [[ "$TARGET_BRANCH" == "main" ]]; then
                    echo "network=production" >> $GITHUB_OUTPUT
                  elif [[ "$TARGET_BRANCH" == "staging" ]]; then
                    echo "network=staging" >> $GITHUB_OUTPUT
                  else
                    # Any other branch will deploy to dev network
                    echo "network=dev" >> $GITHUB_OUTPUT
                  fi


    build_and_deploy:
        runs-on: ubuntu-latest
        needs: setup_environment
        # github actions env
        environment: ${{ needs.setup_environment.outputs.network }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "22"

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                components: clippy, rustfmt
                targets: wasm32-unknown-unknown

            - name: Setup environment
              run: |
                export RUST_BACKTRACE="full"

            - name: Install dfx
              uses: dfinity/setup-dfx@main

            - name: Confirm successful installation
              run: dfx --version

            - name: Install ic-wasm
              run: |
                wget https://github.com/dfinity/ic-wasm/releases/download/0.9.8/ic-wasm-linux64 -O /usr/local/bin/ic-wasm
                chmod +x /usr/local/bin/ic-wasm

            - name: Install candid-extractor
              run: |
                wget https://github.com/dfinity/candid-extractor/releases/download/0.1.6/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -O /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz
                tar -xvf /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -C /usr/local/bin
                chmod +x /usr/local/bin/candid-extractor

            - name: Install Just command runner
              uses: extractions/setup-just@v1

            - name: Create private key file
              run: |
                  echo "${{ secrets.DEPLOYER }}" > private_key.pem

            # DANGEROUS: This is a plaintext identity import
            - name: Import identity
              run: dfx identity import deployer private_key.pem --storage-mode=plaintext
            # DANGEROUS: Do not echo the private key to the console

            - name: Get cashier dev address
              run: |
                  dfx identity use deployer
                  dfx identity get-principal

            - name: Deploy to ${{ needs.setup_environment.outputs.network }} environment
              env:
                  VITE_IC_EXPLORER_BASE_URL: ${{ vars.VITE_IC_EXPLORER_BASE_URL }}
                  VITE_BACKEND_CANISTER_ID: ${{ vars.VITE_BACKEND_CANISTER_ID }}
                  VITE_TOKEN_STORAGE_CANISTER_ID: ${{ vars.VITE_TOKEN_STORAGE_CANISTER_ID }}
                  DFX_WARNING: -mainnet_plaintext_identity
                  NETWORK: ${{ needs.setup_environment.outputs.network }}
              run: |
                  # Create environment file with the correct values
                  env_file = "env.${NETWORK}"
                  
                  # create env file for old frontend
                  echo "VITE_IC_EXPLORER_BASE_URL=${VITE_IC_EXPLORER_BASE_URL}" > src/cashier_frontend/$env_file
                  echo "VITE_BACKEND_CANISTER_ID=${VITE_BACKEND_CANISTER_ID}" >> src/cashier_frontend/$env_file
                  echo "VITE_TOKEN_STORAGE_CANISTER_ID=${VITE_TOKEN_STORAGE_CANISTER_ID}" >> src/cashier_frontend/$env_file
                  echo "VITE_FEATURE_FLAGS_ENABLE_SWAP=true" >> src/cashier_frontend/$env_file
                  echo "VITE_ENV=${NETWORK}" >> src/cashier_frontend/$env_file
                  echo "Created $env_file with values:"
                  cat src/cashier_frontend/$env_file

                  owner=$(dfx identity get-principal)

                  # choose log level based on network: info for production, debug otherwise
                  if [ "$NETWORK" = "production" ]; then
                    backend_log_filter="global,cashier=info"
                    token_storage_log_filter="global,cashier=info,token_storage=info"
                  else
                    backend_log_filter="global,cashier=debug"
                    token_storage_log_filter="global,cashier=debug,token_storage=debug"
                  fi

                  just build "$NETWORK"
                  # pass log filters to just dfx_deploy so canisters pick the appropriate level
                  just dfx_deploy "$owner" "--network=$NETWORK" "$backend_log_filter" "$token_storage_log_filter"