name: Orbit Deploy

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'install mode (upgrade, install, reinstall)'
        required: true
        default: 'reinstall'
      owner:
        description: 'Owner principal used in candid args templates'
        required: true
        default: 'owner-principal'
      backend_log_filter:
        description: 'Optional backend log filter string'
        required: false
        default: ''
      token_storage_log_filter:
        description: 'Optional token_storage log filter string'
        required: false
        default: ''
      submit_request:
        description: 'If true, the workflow will attempt to submit the Orbit request (requires secrets)'
        required: false
        default: 'false'
  # Temporary: trigger on push to this feature branch for testing
  push:
    branches:
      - 'feature/orbit-cli'

jobs:
  setup_environment:
    runs-on: ubuntu-latest
    outputs:
        network: ${{ steps.set-env.outputs.network }}
    steps:
        - name: Set deployment network
          id: set-env
          run: |
              # For pull requests, use base_ref, for pushes use ref_name
              if [[ "${{ github.event_name }}" == "pull_request" ]]; then
                TARGET_BRANCH="${{ github.base_ref }}"
              else
                TARGET_BRANCH="${{ github.ref_name }}"
              fi
              echo "Detected branch: $TARGET_BRANCH"

              if [[ "$TARGET_BRANCH" == "main" ]]; then
                echo "network=production" >> $GITHUB_OUTPUT
              elif [[ "$TARGET_BRANCH" == "staging" ]]; then
                echo "network=staging" >> $GITHUB_OUTPUT
              else
                # Any other branch will deploy to dev network
                echo "network=dev" >> $GITHUB_OUTPUT
              fi

  deploy:
    name: Prepare and Submit Orbit request (optional)
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - name: Setup environment
        run: |
          export RUST_BACKTRACE="full"

      - name: Install dfx
        uses: dfinity/setup-dfx@main

      - name: Confirm successful installation
        run: dfx --version

      - name: Install ic-wasm
        run: |
          wget https://github.com/dfinity/ic-wasm/releases/download/0.9.8/ic-wasm-linux64 -O /usr/local/bin/ic-wasm
          chmod +x /usr/local/bin/ic-wasm

      - name: Install candid-extractor
        run: |
          wget https://github.com/dfinity/candid-extractor/releases/download/0.1.6/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -O /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz
          tar -xvf /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/candid-extractor

      - name: Install Just command runner
        uses: extractions/setup-just@v1

      - name: Create private key file
        run: |
          echo "${{ secrets.DEPLOYER }}" > private_key.pem

      # DANGEROUS: This is a plaintext identity import
      - name: Import identity
        run: dfx identity import deployer private_key.pem --storage-mode=plaintext
      # DANGEROUS: Do not echo the private key to the console

      - name: Use deployer identity
        run: |
          dfx identity use deployer
          owner=$(dfx identity get-principal) || true
          echo "owner=$owner"

      - name: Set log filter
        id: log_filter
        run: |
          if [ "${{ needs.setup_environment.outputs.network }}" = "production" ]; then
            echo "filter=global,cashier=info,token_storage=info" >> $GITHUB_OUTPUT
          else
            echo "filter=global,cashier=debug,token_storage=debug" >> $GITHUB_OUTPUT
          fi

      - name: Build candid args (single run)
        run: |
          owner=$(dfx identity get-principal)
          just build_backend_args "$owner" "${{ steps.log_filter.outputs.filter }}" backend_args.txt
          just build_token_storage_args "$owner" "${{ steps.log_filter.outputs.filter }}" token_storage_args.txt
          echo "Backend args:"
          cat backend_args.txt
          echo ""
          echo "Token storage args:"
          cat token_storage_args.txt

      - name: Compute checksums
        run: |
          echo 'WASM checksum (backend):'
          just sha256_file target/artifacts/cashier_backend.wasm.gz || true
          echo 'WASM checksum (token_storage):'
          just sha256_file target/artifacts/token_storage.wasm.gz || true
          echo 'Candid args checksum (token_storage):'
          just sha256_encoded_candid token_storage_args.txt target/artifacts/token_storage.did || true

      - name: Install dfx-orbit (only when submitting request)
        if: ${{ github.event.inputs.submit_request == 'true' }}
        run: cargo install -f --git https://github.com/dfinity/orbit.git --bin dfx-orbit

      - name: Upgrade token_storage canister
        id: token_storage
        if: ${{ github.event.inputs.submit_request == 'true' }}
        env:
          DFX_WARNING: -mainnet_plaintext_identity
        run: |
          canister_id=$(dfx canister id token_storage --network ${{ needs.setup_environment.outputs.network }})
          wasm_path="target/artifacts/token_storage.wasm.gz"
          wasm_checksum=$(sha256sum "$wasm_path" | awk '{print $1}')
          arg=$(cat token_storage_args.txt)
          arg_checksum=$(just sha256_encoded_candid token_storage_args.txt target/artifacts/token_storage.did)

          echo "=== Upgrading token_storage canister ==="
          echo "Canister ID: $canister_id"
          echo "WASM Checksum: $wasm_checksum"
          echo "Arg Checksum: $arg_checksum"

          output=$(dfx-orbit request canister install --mode ${{ github.event.inputs.mode }} "$canister_id" --wasm "$wasm_path" --argument "$arg" 2>&1) || true
          echo "$output"
          request_url=$(echo "$output" | grep -oE 'Request URL: https://[^ ]+' | sed 's/Request URL: //')

          echo "wasm_checksum=$wasm_checksum" >> $GITHUB_OUTPUT
          echo "arg_checksum=$arg_checksum" >> $GITHUB_OUTPUT
          echo "request_url=$request_url" >> $GITHUB_OUTPUT

      - name: Upgrade backend canister
        id: backend
        if: ${{ github.event.inputs.submit_request == 'true' }}
        env:
          DFX_WARNING: -mainnet_plaintext_identity
        run: |
          canister_id=$(dfx canister id cashier_backend --network ${{ needs.setup_environment.outputs.network }})
          wasm_path="target/artifacts/cashier_backend.wasm.gz"
          wasm_checksum=$(sha256sum "$wasm_path" | awk '{print $1}')
          arg=$(cat backend_args.txt)
          arg_checksum=$(just sha256_encoded_candid backend_args.txt target/artifacts/cashier_backend.did)

          echo "=== Upgrading backend canister ==="
          echo "Canister ID: $canister_id"
          echo "WASM Checksum: $wasm_checksum"
          echo "Arg Checksum: $arg_checksum"

          output=$(dfx-orbit request canister install --mode ${{ github.event.inputs.mode }} "$canister_id" --wasm "$wasm_path" --argument "$arg" 2>&1) || true
          echo "$output"
          request_url=$(echo "$output" | grep -oE 'Request URL: https://[^ ]+' | sed 's/Request URL: //')

          echo "wasm_checksum=$wasm_checksum" >> $GITHUB_OUTPUT
          echo "arg_checksum=$arg_checksum" >> $GITHUB_OUTPUT
          echo "request_url=$request_url" >> $GITHUB_OUTPUT

      - name: Write Job Summary
        if: ${{ github.event.inputs.submit_request == 'true' }}
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ðŸš€ Orbit Deploy Summary

          | Parameter | Value |
          |-----------|-------|
          | **Network** | \`${{ needs.setup_environment.outputs.network }}\` |
          | **Mode** | \`${{ github.event.inputs.mode }}\` |

          ### Token Storage Canister

          | Field | Value |
          |-------|-------|
          | **WASM Checksum** | \`${{ steps.token_storage.outputs.wasm_checksum }}\` |
          | **Arg Checksum** | \`${{ steps.token_storage.outputs.arg_checksum }}\` |
          | **Request URL** | ${{ steps.token_storage.outputs.request_url }} |

          ### Backend Canister

          | Field | Value |
          |-------|-------|
          | **WASM Checksum** | \`${{ steps.backend.outputs.wasm_checksum }}\` |
          | **Arg Checksum** | \`${{ steps.backend.outputs.arg_checksum }}\` |
          | **Request URL** | ${{ steps.backend.outputs.request_url }} |

          ---
          *Deployed at: $(date -u "+%Y-%m-%d %H:%M:%S UTC")*
          EOF
