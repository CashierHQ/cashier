name: "Build test backend"

on:
  pull_request:
    branches: [main, dev, staging]
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/cashier_backend/**'
      - 'src/cashier_backend_client/**'
      - 'src/cashier_backend_types/**'
      - 'src/gate_service/**'
      - 'src/gate_service_client/**'
      - 'src/gate_service_types/**'
      - 'src/token_storage/**'
      - 'src/token_storage_client/**'
      - 'src/token_storage_types/**'
      - 'src/transaction_manager/**'
      - 'src/integration_tests/**'
      - 'src/lib/**'
      - 'src/cashier_frontend_new/src/lib/generated/**'
      - 'Cargo.toml'
      - 'Cargo.lock'

concurrency:
  group: backend-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  rust-check:
    name: "Rust Code Check"
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Just command runner
        uses: extractions/setup-just@v1

      - name: Configure Rust Cache
        uses: swatinem/rust-cache@v2
        if: ${{ (github.event.pull_request.base.ref != 'main') && (github.ref_name != 'main') }}
        with:
          shared-key: ${{ github.repository }}
          save-if: ${{ github.ref_type != 'tag' }}

      - name: Rust - Check code style
        run: |
          just check_code

  backend-build:
    name: "Backend Build"
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: wasm32-unknown-unknown

      - name: Install Just command runner
        uses: extractions/setup-just@v1

      - name: Install dfx
        uses: dfinity/setup-dfx@main
        with:
          dfx-version: "0.29.2"

      - name: Install ic-wasm
        run: |
          wget https://github.com/dfinity/ic-wasm/releases/download/0.9.8/ic-wasm-linux64 -O /usr/local/bin/ic-wasm
          chmod +x /usr/local/bin/ic-wasm

      - name: Install candid-extractor
        run: |
          wget https://github.com/dfinity/candid-extractor/releases/download/0.1.6/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -O /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz
          tar -xvf /tmp/candid-extractor-x86_64-unknown-linux-gnu.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/candid-extractor

      - name: Configure Rust Cache
        uses: swatinem/rust-cache@v2
        if: ${{ (github.event.pull_request.base.ref != 'main') && (github.ref_name != 'main') }}
        with:
          shared-key: ${{ github.repository }}
          save-if: ${{ github.ref_type != 'tag' }}

      - name: Build
        run: |
          just build

      - name: Unit Test
        run: |
          just test_unit

      - name: Upload wasm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-artifacts
          path: target/artifacts/
          retention-days: 1

  integration-test:
    name: "Integration Test (shard ${{ matrix.partition }}/${{ matrix.total }})"
    needs: backend-build
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        partition: [1, 2, 3]
        total: [3]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Just command runner
        uses: extractions/setup-just@v1

      - name: Install cargo-nextest
        run: |
          curl -LsSf https://get.nexte.st/latest/linux | tar zxf - -C /usr/local/bin

      - name: Configure Rust Cache
        uses: swatinem/rust-cache@v2
        if: ${{ (github.event.pull_request.base.ref != 'main') && (github.ref_name != 'main') }}
        with:
          shared-key: ${{ github.repository }}
          save-if: false

      - name: Download wasm artifacts
        uses: actions/download-artifact@v4
        with:
          name: wasm-artifacts
          path: target/artifacts

      - name: Run integration tests (shard ${{ matrix.partition }}/${{ matrix.total }})
        run: |
          just test_integration ${{ matrix.partition }} ${{ matrix.total }}

  backend-test-i686:
    name: "Backend Test (i686)"
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt
          targets: i686-unknown-linux-gnu

      - name: Install Just command runner
        uses: extractions/setup-just@v1

      - name: Configure Rust Cache
        uses: swatinem/rust-cache@v2
        if: ${{ (github.event.pull_request.base.ref != 'main') && (github.ref_name != 'main') }}
        with:
          shared-key: ${{ github.repository }}
          save-if: ${{ github.ref_type != 'tag' }}

      - name: Setup environment
        run: |
          export RUST_BACKTRACE="full"
          sudo apt update
          sudo apt install gcc-multilib

      - name: Test - 32 bits
        run: |
          just test_unit_i686
