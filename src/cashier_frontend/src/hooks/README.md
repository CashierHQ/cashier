# useLinkAssetBalance Hook - Subaccount Parsing Utilities

This document explains the subaccount parsing utilities created for the `useLinkAssetBalance` hook.

## Overview

The hook manages link asset balances by creating deterministic subaccounts from link IDs. The subaccount parsing utilities provide ways to convert between different representations of subaccount data.

## Core Functions

### 1. `linkIdToSubaccount(id: string): Uint8Array`

Converts a UUID string (link ID) to a 32-byte subaccount.

```typescript
const linkId = "550e8400-e29b-41d4-a716-446655440000";
const subaccount = linkIdToSubaccount(linkId);
// Returns: Uint8Array(32) with UUID bytes in first 16 positions
```

**Important**: Do not change the byte order as this affects account derivation.

### 2. `subaccountToLinkId(subaccount: Uint8Array): string | null`

Parses the first 16 bytes of a subaccount back to the original UUID string.

```typescript
const subaccount = linkIdToSubaccount("550e8400-e29b-41d4-a716-446655440000");
const linkId = subaccountToLinkId(subaccount);
// Returns: "550e8400-e29b-41d4-a716-446655440000"
```

### 3. `subaccountToHexString(subaccount: Uint8Array): string`

Converts subaccount bytes to a hexadecimal string representation.

```typescript
const subaccount = linkIdToSubaccount("550e8400-e29b-41d4-a716-446655440000");
const hexString = subaccountToHexString(subaccount);
// Returns: "550e8400e29b41d4a71644665544000000000000000000000000000000000000"
```

### 4. `hexStringToSubaccount(hexString: string): Uint8Array | null`

Converts a 64-character hex string back to a 32-byte subaccount.

```typescript
const hexString = "550e8400e29b41d4a71644665544000000000000000000000000000000000000";
const subaccount = hexStringToSubaccount(hexString);
// Returns: Uint8Array(32) or null if invalid
```

### 5. `getAccountInfo(linkId: string): AccountInfo`

Utility function that provides comprehensive account information for debugging.

```typescript
const accountInfo = getAccountInfo("550e8400-e29b-41d4-a716-446655440000");
console.log(accountInfo);
// Returns:
// {
//   linkId: "550e8400-e29b-41d4-a716-446655440000",
//   owner: "backend-canister-id",
//   subaccount: Uint8Array(32),
//   subaccountHex: "550e8400e29b41d4a71644665544000000000000000000000000000000000000",
//   parsedLinkId: "550e8400-e29b-41d4-a716-446655440000",
//   account: { owner: Principal, subaccount: Uint8Array }
// }
```

## Usage Examples

### Basic Balance Fetching

```typescript
import { useLinkAssetBalance } from '@/hooks/useLinkAssetBalance';

function LinkComponent({ link }) {
  const { balances, loading, error, refetch } = useLinkAssetBalance(link);

  if (loading) return <div>Loading balances...</div>;
  if (error) return <div>Error: {error}</div>;

  return (
    <div>
      {balances.map((balance, index) => (
        <div key={index}>
          Token: {balance.tokenAddress.toString()}
          Balance: {balance.balance.toString()}
        </div>
      ))}
      <button onClick={refetch}>Refresh</button>
    </div>
  );
}
```

### Debugging Account Information

```typescript
import { getAccountInfo } from "@/hooks/useLinkAssetBalance";

function debugLink(linkId: string) {
    const accountInfo = getAccountInfo(linkId);
    console.log("Account Debug Info:", accountInfo);

    // Verify round-trip conversion
    const originalId = accountInfo.linkId;
    const parsedId = accountInfo.parsedLinkId;
    console.log("Round-trip successful:", originalId === parsedId);
}
```

### Converting Between Formats

```typescript
import {
    linkIdToSubaccount,
    subaccountToHexString,
    hexStringToSubaccount,
    subaccountToLinkId,
} from "@/hooks/useLinkAssetBalance";

const linkId = "550e8400-e29b-41d4-a716-446655440000";

// Convert to subaccount
const subaccount = linkIdToSubaccount(linkId);

// Convert to hex for logging/storage
const hexString = subaccountToHexString(subaccount);

// Convert back from hex
const restoredSubaccount = hexStringToSubaccount(hexString);

// Convert back to link ID
const restoredLinkId = subaccountToLinkId(restoredSubaccount);

console.log("Original:", linkId);
console.log("Restored:", restoredLinkId);
console.log("Match:", linkId === restoredLinkId);
```

## Error Handling

All parsing functions include proper error handling:

-   `subaccountToLinkId`: Returns `null` if UUID parsing fails
-   `hexStringToSubaccount`: Returns `null` if hex string is invalid
-   Console errors are logged for debugging purposes

## Security Considerations

1. **Deterministic Generation**: Subaccounts are generated deterministically from link IDs
2. **Byte Order**: The byte order in `linkIdToSubaccount` must not be changed
3. **Validation**: All parsing functions validate input before processing
4. **Error Boundaries**: Failed parsing operations don't crash the application

## Integration with ICRC Standards

The subaccounts generated by these utilities are compatible with:

-   ICRC-1 token standard
-   ICRC-2 approve/transfer_from functionality
-   Internet Computer Principal/Account system

The resulting accounts follow the format:

```
{
  owner: Principal (backend canister),
  subaccount: Uint8Array(32) (derived from link ID)
}
```
